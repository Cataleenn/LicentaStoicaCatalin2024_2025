<app-navbar></app-navbar>

<div class="clustering-dashboard">
  <div class="dashboard-header">
    <h1>🧠 Analiza Comportamentală Avansată</h1>
    <p>Recunoașterea pattern-urilor comportamentale și insight-uri demografice detaliate</p>
  </div>

  <!-- ✅ NEW: Category Consistency Section -->
  <div class="category-consistency-section">
    <mat-card class="consistency-card">
      <mat-card-header>
        <mat-card-title>🔧 Consistența Categoriilor</mat-card-title>
        <mat-card-subtitle>Verifică și standardizează categoriile pentru analiză precisă</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="consistency-actions">
          <button 
            mat-raised-button 
            color="primary"
            [disabled]="isCheckingConsistency"
            (click)="checkCategoryConsistency()">
            <span *ngIf="!isCheckingConsistency">🔍 Verifică Consistența</span>
            <span *ngIf="isCheckingConsistency">
              <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
              Se verifică...
            </span>
          </button>
          
          <button 
            mat-raised-button 
            color="warn"
            [disabled]="isFixingCategories"
            (click)="fixAllCategories()">
            <span *ngIf="!isFixingCategories">🔧 Standardizează Toate Categoriile</span>
            <span *ngIf="isFixingCategories">
              <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
              Se standardizează...
            </span>
          </button>
        </div>

        <!-- Category Consistency Results -->
        <div *ngIf="categoryConsistencyResults" class="consistency-results">
          <h4>📊 Rezultatele Verificării</h4>
          <div class="consistency-stats">
            <div class="stat-item">
              <strong>Total răspunsuri:</strong> {{ categoryConsistencyResults.data.totalResponses }}
            </div>
            <div class="stat-item">
              <strong>Variații demografice:</strong> {{ categoryConsistencyResults.summary.totalDemographicVariations }}
            </div>
            <div class="stat-item">
              <strong>Variații comportamentale:</strong> {{ categoryConsistencyResults.summary.totalBehavioralVariations }}
            </div>
            <div class="stat-item">
              <strong>Stare:</strong> 
              <span [ngStyle]="{
                color: getCategoryConsistencyStatus() === 'good' ? '#4caf50' : 
                       getCategoryConsistencyStatus() === 'fair' ? '#ff9800' : '#f44336'
              }">
                {{ getCategoryConsistencyStatus() === 'good' ? 'Bună' : 
                   getCategoryConsistencyStatus() === 'fair' ? 'Acceptabilă' : 'Necesită îmbunătățire' }}
              </span>
            </div>
          </div>

          <!-- Warning if categories need fixing -->
          <div *ngIf="shouldShowCategoryWarning()" class="category-details">
            <h5>⚠️ Atenție: Categorii Inconsistente Detectate</h5>
            <p>S-au detectat prea multe variații în categoriile demografice și comportamentale. 
               Aceasta poate afecta calitatea analizei de clustering. Se recomandă folosirea butonului 
               "Standardizează Toate Categoriile" pentru a corecta aceste inconsistențe.</p>
          </div>

          <!-- Details about category variations -->
          <div class="category-details">
            <h5>📋 Detalii Demografice</h5>
            <div class="category-list">
              <div><strong>Grupe de vârstă:</strong> {{ categoryConsistencyResults.data.demographicCategories.ageGroups.join(', ') }}</div>
              <div><strong>Genuri:</strong> {{ categoryConsistencyResults.data.demographicCategories.genders.join(', ') }}</div>
              <div><strong>Nivele educație:</strong> {{ categoryConsistencyResults.data.demographicCategories.educationLevels.join(', ') }}</div>
              <div><strong>Ocupații:</strong> {{ categoryConsistencyResults.data.demographicCategories.occupations.join(', ') }}</div>
              <div><strong>Nivele STEM:</strong> {{ categoryConsistencyResults.data.demographicCategories.stemLevels.join(', ') }}</div>
            </div>

            <h5>🧠 Detalii Comportamentale</h5>
            <div class="category-list">
              <div><strong>Stiluri rezolvare probleme:</strong> {{ categoryConsistencyResults.data.behavioralCategories.problemSolvingStyles.join(', ') }}</div>
              <div><strong>Nivele comfort tehnic:</strong> {{ categoryConsistencyResults.data.behavioralCategories.techComfortLevels.join(', ') }}</div>
              <div><strong>Stiluri gestionare erori:</strong> {{ categoryConsistencyResults.data.behavioralCategories.errorHandlingStyles.join(', ') }}</div>
              <div><strong>Experiență asamblare:</strong> {{ categoryConsistencyResults.data.behavioralCategories.assemblyExperience.join(', ') }}</div>
              <div><strong>Frecvență gaming:</strong> {{ categoryConsistencyResults.data.behavioralCategories.gamingFrequencies.join(', ') }}</div>
            </div>
          </div>
        </div>

        <!-- Fix Categories Results -->
        <div *ngIf="fixCategoriesResults" class="consistency-results">
          <h4>🔧 Rezultatele Standardizării</h4>
          <div class="consistency-stats">
            <div class="stat-item">
              <strong>Răspunsuri procesate:</strong> {{ fixCategoriesResults.data.processedCount }}
            </div>
            <div class="stat-item">
              <strong>Categorii corectate:</strong> {{ fixCategoriesResults.data.categoriesFixed }}
            </div>
            <div class="stat-item">
              <strong>Procentaj îmbunătățire:</strong> {{ fixCategoriesResults.data.fixPercentage }}
            </div>
          </div>
          <p><strong>Recomandare:</strong> {{ fixCategoriesResults.recommendation }}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Fisher Test Component -->
  <app-fisher-test [surveyId]="selectedSurveyId"></app-fisher-test>

  <mat-tab-group class="main-tabs">
    <!-- Tab 1: Survey Selection & Overview -->
    <mat-tab label="📊 Prezentare Generală">
      <div class="tab-content">
        <!-- Survey Selection Card -->
        <div class="survey-selection">
          <mat-card class="selection-card">
            <mat-card-header>
              <mat-card-title>Selectează Chestionarul pentru Analiză</mat-card-title>
              <mat-card-subtitle>Alege un chestionar cu răspunsuri complete pentru a analiza pattern-urile comportamentale</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <!-- Loading State -->
              <div *ngIf="isLoadingSurveys" class="loading-container">
                <mat-spinner diameter="30"></mat-spinner>
                <p>Se încarcă chestionarele...</p>
              </div>
              
              <!-- Survey Selection Controls -->
              <div *ngIf="!isLoadingSurveys" class="selection-controls">
                <mat-select 
                  [(value)]="selectedSurveyId" 
                  placeholder="Selectează un chestionar..."
                  (selectionChange)="onSurveySelected($event.value)">
                  <mat-option *ngFor="let survey of availableSurveys" [value]="survey.id">
                    {{ survey.formTitle }} 
                    <span style="color: #666; margin-left: 8px;">
                      ({{ survey.responseCount || 0 }} răspunsuri)
                    </span>
                  </mat-option>
                </mat-select>
                
                <!-- Analysis Button -->
                <button 
                  mat-raised-button 
                  color="primary"
                  [disabled]="!selectedSurveyId || isAnalyzing"
                  (click)="startClusteringAnalysis()">
                  <span *ngIf="!isAnalyzing">🔬 Pornește Analiza</span>
                  <span *ngIf="isAnalyzing">
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    Se analizează...
                  </span>
                </button>
                
                <!-- Recompute Metrics Button -->
                <button 
                  mat-raised-button 
                  color="accent"
                  [disabled]="!selectedSurveyId || isRecomputing"
                  (click)="recomputeMetrics()">
                  <span *ngIf="!isRecomputing">⚙️ Recalculează Metricile</span>
                  <span *ngIf="isRecomputing">
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    Se recalculează...
                  </span>
                </button>
              </div>
              
              <!-- Error Message -->
              <div *ngIf="errorMessage" class="error-container">
                <mat-icon color="warn">error</mat-icon>
                <span>{{ errorMessage }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Analysis Results Section -->
        <div *ngIf="clusteringSummary" class="analysis-results">
          <!-- Overview Statistics -->
          <div class="overview-stats">
            <mat-card class="summary-card">
              <mat-card-header>
                <mat-card-title>Rezultatele Analizei</mat-card-title>
                <mat-card-subtitle>Scorul de calitate: {{ (clusteringSummary.qualityScore * 100).toFixed(1) }}%</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-stats">
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalClusters }}</div>
                    <div class="stat-label">Grupuri Comportamentale</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalParticipants }}</div>
                    <div class="stat-label">Participanți Analizați</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ getUniqueOccupations() }}</div>
                    <div class="stat-label">Ocupații Diferite</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Insights Card -->
            <mat-card class="insights-card" *ngIf="clusteringSummary.insights && clusteringSummary.insights.length > 0">
              <mat-card-header>
                <mat-card-title>💡 Insight-uri Cheie</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <ul class="insights-list">
                  <li *ngFor="let insight of clusteringSummary.insights">{{ insight }}</li>
                </ul>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Detailed Clusters Section -->
          <div class="clusters-detailed">
            <h2>🎯 Profilurile Comportamentale Identificate</h2>
            
            <mat-accordion class="clusters-accordion">
              <mat-expansion-panel 
                *ngFor="let cluster of clusteringSummary.clusters; let i = index"
                class="cluster-panel"
                [ngClass]="'cluster-panel-' + i">
                
                <!-- Cluster Header -->
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <div class="cluster-header">
                      <div class="cluster-icon">{{ getClusterIcon(cluster.name) }}</div>
                      <div class="cluster-basic-info">
                        <h3>{{ cluster.name }}</h3>
                        <div class="cluster-stats">
                          <span class="participant-count">{{ cluster.size }} participanți</span>
                          <span class="percentage">({{ cluster.percentage.toFixed(1) }}%)</span>
                          <span class="performance-badge" [ngClass]="getPerformanceBadgeClass(cluster.performanceMetrics.technicalAptitude)">
                            {{ getPerformanceLabel(cluster.performanceMetrics.technicalAptitude) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ cluster.description }}
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Cluster Detailed Content -->
                <div class="cluster-detailed-content">
                  <!-- Performance Metrics -->
                  <div class="metrics-section">
                    <h4>📊 Metrici de Performanță</h4>
                    <div class="metrics-grid">
                      <div class="metric-item">
                        <div class="metric-label">Aptitudine Tehnică</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.technicalAptitude * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.technicalAptitude * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Viteză</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.speedIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.speedIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Precizie</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.precisionIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.precisionIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Încredere</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.confidenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.confidenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Sistematic</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.systematicIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.systematicIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Persistență</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.persistenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.persistenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Detailed Profile -->
                  <div class="profile-section">
                    <h4>👤 Profil Demografic și Comportamental Detaliat</h4>
                    <div class="profile-content" [innerHTML]="formatProfileForDisplay(cluster.detailedProfile)"></div>
                  </div>

                  <!-- Key Characteristics -->
                  <div class="characteristics-section" *ngIf="cluster.characteristics && cluster.characteristics.length > 0">
                    <h4>🏷️ Caracteristici Cheie</h4>
                    <div class="characteristics-tags">
                      <span 
                        *ngFor="let char of cluster.characteristics" 
                        class="characteristic-tag">
                        {{ char }}
                      </span>
                    </div>
                  </div>

                  <!-- Cluster Actions -->
                  <div class="cluster-actions">
                    <button 
                      mat-stroked-button 
                      color="primary"
                      (click)="viewClusterDetails(cluster.id)">
                      👁️ Vezi Participanții
                    </button>
                    <button 
                      mat-stroked-button 
                      color="accent"
                      (click)="exportClusterData(cluster.id)">
                      📊 Exportă Date
                    </button>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </div>

        <!-- Placeholder when no analysis is available -->
        <div *ngIf="!clusteringSummary && !isAnalyzing" class="placeholder-message">
          <mat-icon>analytics</mat-icon>
          <h3>Pregătit pentru Analiză</h3>
          <p>Selectează un chestionar și pornește analiza pentru a descoperi pattern-urile comportamentale ale participanților.</p>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Advanced Analytics -->
    <mat-tab label="📈 Analiză Avansată">
      <div class="tab-content">
        <div class="placeholder-message">
          <mat-icon>assessment</mat-icon>
          <h3>Analiză Avansată</h3>
          <p>Funcționalitate în dezvoltare - analize detaliate și comparații între chestionare.</p>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 3: Insights & Reports -->
    <mat-tab label="📋 Rapoarte & Insight-uri">
      <div class="tab-content">
        <div class="placeholder-message">
          <mat-icon>description</mat-icon>
          <h3>Rapoarte & Insight-uri</h3>
          <p>Funcționalitate în dezvoltare - generare automată de rapoarte și insight-uri acționabile.</p>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>