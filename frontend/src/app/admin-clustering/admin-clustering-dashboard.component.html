<!-- Optimized Dashboard Template - admin-clustering-dashboard.component.html -->
<app-navbar></app-navbar>

<div class="clustering-dashboard">
  <div class="dashboard-header">
    <h1>ğŸ§  Analiza ComportamentalÄƒ AvansatÄƒ</h1>
    <p>RecunoaÈ™terea pattern-urilor comportamentale cu optimizare automatÄƒ pentru rezultate de calitate maximÄƒ</p>
  </div>

  <mat-tab-group class="main-tabs">
    <!-- Tab 1: Survey Selection & Overview -->
    <mat-tab label="ğŸ“Š AnalizÄƒ OptimizatÄƒ">
      <div class="tab-content">
        <!-- Survey Selection Card -->
        <div class="survey-selection">
          <mat-card class="selection-card">
            <mat-card-header>
              <mat-card-title>SelecteazÄƒ Chestionarul pentru AnalizÄƒ OptimizatÄƒ</mat-card-title>
              <mat-card-subtitle>
                ğŸš€ Noul sistem optimizeazÄƒ automat calitatea clustering-ului prin multiple iteraÈ›ii
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <!-- Loading State -->
              <div *ngIf="isLoadingSurveys" class="loading-container">
                <mat-spinner diameter="30"></mat-spinner>
                <p>Se Ã®ncarcÄƒ chestionarele...</p>
              </div>
              
              <!-- Survey Selection Controls -->
              <div *ngIf="!isLoadingSurveys" class="selection-controls">
                <mat-select 
                  [(value)]="selectedSurveyId" 
                  placeholder="SelecteazÄƒ un chestionar..."
                  (selectionChange)="onSurveySelected($event.value)">
                  <mat-option *ngFor="let survey of availableSurveys" [value]="survey.id">
                    {{ survey.formTitle }} 
                    <span style="color: #666; margin-left: 8px;">
                      ({{ survey.responseCount || 0 }} rÄƒspunsuri)
                    </span>
                  </mat-option>
                </mat-select>
                
                <!-- âœ… MODIFIED: Single optimized analysis button -->
                <button 
                  mat-raised-button 
                  color="primary"
                  [disabled]="!selectedSurveyId || isAnalyzing"
                  (click)="startClusteringAnalysis()">
                  <span *ngIf="!isAnalyzing">ğŸš€ PorneÈ™te Analiza OptimizatÄƒ</span>
                  <span *ngIf="isAnalyzing">
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    Se optimizeazÄƒ...
                  </span>
                </button>
              </div>
              
              <!-- âœ… NEW: Optimization Progress Display -->
              <div *ngIf="optimizationProgress" class="optimization-progress">
                <div class="progress-header">
                  <h4>ğŸ”„ Optimizare Ã®n Curs</h4>
                  <span class="progress-time">{{ formatDuration(optimizationProgress.timeElapsed) }}</span>
                </div>
                
                <div class="progress-status">
                  <span>{{ getOptimizationStatusText() }}</span>
                  <span class="iteration-info">
                    (IteraÈ›ia {{ optimizationProgress.currentIteration }} din {{ optimizationProgress.totalIterations }})
                  </span>
                </div>
                
                <mat-progress-bar 
                  mode="determinate" 
                  [value]="getOptimizationProgress()"
                  class="optimization-progress-bar">
                </mat-progress-bar>
                
                <div class="progress-stats" *ngIf="optimizationProgress.bestQualityScore > 0">
                  <span>Cel mai bun scor pÃ¢nÄƒ acum: {{ (optimizationProgress.bestQualityScore * 100).toFixed(1) }}%</span>
                </div>
              </div>
              
              <!-- Error Message -->
              <div *ngIf="errorMessage" class="error-container">
                <mat-icon color="warn">error</mat-icon>
                <span>{{ errorMessage }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- âœ… NEW: Optimization Results Display -->
        <div *ngIf="optimizationResult && !isAnalyzing" class="optimization-results">
          <mat-card class="optimization-summary-card">
            <mat-card-header>
              <mat-card-title>
                ğŸ¯ Rezultatul OptimizÄƒrii
                <span class="quality-badge" [ngClass]="getOptimizationQualityBadgeClass()">
                  {{ getOptimizationQualityBadge() }}
                </span>
              </mat-card-title>
              <mat-card-subtitle>{{ optimizationResult.optimizationSummary }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="optimization-metrics">
                <div class="metric">
                  <span class="metric-label">Calitate IniÈ›ialÄƒ:</span>
                  <span class="metric-value">{{ (optimizationResult.initialQualityScore * 100).toFixed(1) }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Calitate FinalÄƒ:</span>
                  <span class="metric-value final">{{ (optimizationResult.finalQualityScore * 100).toFixed(1) }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">ÃmbunÄƒtÄƒÈ›ire:</span>
                  <span class="metric-value improvement" 
                        [ngClass]="{'positive': optimizationResult.qualityImprovement > 0, 'neutral': optimizationResult.qualityImprovement <= 0}">
                    {{ optimizationResult.qualityImprovement > 0 ? '+' : '' }}{{ optimizationResult.qualityImprovement.toFixed(1) }}%
                  </span>
                </div>
                <div class="metric">
                  <span class="metric-label">Timp Total:</span>
                  <span class="metric-value">{{ formatDuration(optimizationResult.totalDuration) }}</span>
                </div>
              </div>
              
              <!-- Optimization Details Toggle -->
              <div class="optimization-details-toggle">
                <button 
                  mat-button 
                  (click)="showOptimizationDetails = !showOptimizationDetails">
                  {{ showOptimizationDetails ? 'ğŸ”¼ Ascunde' : 'ğŸ”½ Vezi' }} Detaliile OptimizÄƒrii
                </button>
              </div>
              
              <!-- Detailed Optimization Steps -->
              <div *ngIf="showOptimizationDetails" class="optimization-details">
                <h5>ğŸ“‹ PaÈ™ii OptimizÄƒrii:</h5>
                <div class="iteration-list">
                  <div 
                    *ngFor="let iteration of optimizationResult.iterations; let i = index"
                    class="iteration-item"
                    [ngClass]="{'best-iteration': iteration.qualityScore === optimizationResult.finalQualityScore}">
                    <div class="iteration-header">
                      <span class="iteration-number">{{ iteration.iteration }}</span>
                      <span class="iteration-action">{{ getIterationActionLabel(iteration.action) }}</span>
                      <span class="iteration-quality">{{ (iteration.qualityScore * 100).toFixed(1) }}%</span>
                      <span class="iteration-duration">{{ formatDuration(iteration.duration) }}</span>
                    </div>
                    <div class="iteration-clusters">{{ iteration.clusterCount }} clustere</div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Analysis Results Section -->
        <div *ngIf="clusteringSummary" class="analysis-results">
          <!-- Overview Statistics -->
          <div class="overview-stats">
            <mat-card class="summary-card">
              <mat-card-header>
                <mat-card-title>ğŸ“Š Rezultatele Analizei Optimizate</mat-card-title>
                <mat-card-subtitle>
                  Scorul de calitate: {{ (clusteringSummary.qualityScore * 100).toFixed(1) }}%
                  <span *ngIf="optimizationResult" class="optimization-indicator">
                    âœ¨ OPTIMIZAT
                  </span>
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-stats">
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalClusters }}</div>
                    <div class="stat-label">Grupuri Comportamentale</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalParticipants }}</div>
                    <div class="stat-label">ParticipanÈ›i AnalizaÈ›i</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ getUniqueOccupations() }}</div>
                    <div class="stat-label">OcupaÈ›ii Diferite</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Insights Card -->
            <mat-card class="insights-card" *ngIf="clusteringSummary.insights && clusteringSummary.insights.length > 0">
              <mat-card-header>
                <mat-card-title>ğŸ’¡ Insight-uri Cheie</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <ul class="insights-list">
                  <li *ngFor="let insight of clusteringSummary.insights">{{ insight }}</li>
                </ul>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Detailed Clusters Section -->
          <div class="clusters-detailed">
            <h2>ğŸ¯ Profilurile Comportamentale Identificate</h2>
            
            <mat-accordion class="clusters-accordion">
              <mat-expansion-panel 
                *ngFor="let cluster of clusteringSummary.clusters; let i = index"
                class="cluster-panel"
                [ngClass]="'cluster-panel-' + i">
                
                <!-- Cluster Header -->
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <div class="cluster-header">
                      <div class="cluster-icon">{{ getClusterIcon(cluster.name) }}</div>
                      <div class="cluster-basic-info">
                        <h3>{{ cluster.name }}</h3>
                        <div class="cluster-stats">
                          <span class="participant-count">{{ cluster.size }} participanÈ›i</span>
                          <span class="percentage">({{ cluster.percentage.toFixed(1) }}%)</span>
                          <span class="performance-badge" [ngClass]="getPerformanceBadgeClass(cluster.performanceMetrics.technicalAptitude)">
                            {{ getPerformanceLabel(cluster.performanceMetrics.technicalAptitude) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ cluster.description }}
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Cluster Detailed Content -->
                <div class="cluster-detailed-content">
                  <!-- Performance Metrics -->
                  <div class="metrics-section">
                    <h4>ğŸ“Š Metrici de PerformanÈ›Äƒ</h4>
                    <div class="metrics-grid">
                      <div class="metric-item">
                        <div class="metric-label">Aptitudine TehnicÄƒ</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.technicalAptitude * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.technicalAptitude * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index VitezÄƒ</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.speedIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.speedIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Precizie</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.precisionIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.precisionIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Ãncredere</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.confidenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.confidenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Sistematic</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.systematicIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.systematicIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index PersistenÈ›Äƒ</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.persistenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.persistenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Detailed Profile -->
                  <div class="profile-section">
                    <h4>ğŸ‘¤ Profil Demografic È™i Comportamental Detaliat</h4>
                    <div class="profile-content" [innerHTML]="formatProfileForDisplay(cluster.detailedProfile)"></div>
                  </div>

                  <!-- Key Characteristics -->
                  <div class="characteristics-section" *ngIf="cluster.characteristics && cluster.characteristics.length > 0">
                    <h4>ğŸ·ï¸ Caracteristici Cheie</h4>
                    <div class="characteristics-tags">
                      <span 
                        *ngFor="let char of cluster.characteristics" 
                        class="characteristic-tag">
                        {{ char }}
                      </span>
                    </div>
                  </div>

                  <!-- Cluster Actions -->
                  <div class="cluster-actions">
                    <button 
                      mat-stroked-button 
                      color="primary"
                      (click)="viewClusterDetails(cluster.id)">
                      ğŸ‘ï¸ Vezi ParticipanÈ›ii
                    </button>
                    <button 
                      mat-stroked-button 
                      color="accent"
                      (click)="exportClusterData(cluster.id)">
                      ğŸ“Š ExportÄƒ Date
                    </button>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </div>

        <!-- Placeholder when no analysis has been run -->
        <div *ngIf="!clusteringSummary && !isAnalyzing && !optimizationProgress" class="placeholder-message">
          <mat-icon>analytics</mat-icon>
          <h3>Analiza ComportamentalÄƒ OptimizatÄƒ</h3>
          <p>
            SelecteazÄƒ un chestionar È™i porneÈ™te analiza optimizatÄƒ pentru a descoperi 
            pattern-urile comportamentale cu cea mai bunÄƒ calitate posibilÄƒ.
          </p>
          <p>
            <strong>Noul sistem optimizeazÄƒ automat:</strong><br>
            âœ… RecalculeazÄƒ metricile pentru consistenÈ›Äƒ<br>
            âœ… TesteazÄƒ diferite numere de clustere<br>
            âœ… ReturneazÄƒ rezultatul cu calitatea maximÄƒ
          </p>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Fisher Test (existing) -->
    <mat-tab label="ğŸ”¬ AnalizÄƒ Fisher">
      <div class="tab-content">
        <app-fisher-test [surveyId]="selectedSurveyId"></app-fisher-test>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>