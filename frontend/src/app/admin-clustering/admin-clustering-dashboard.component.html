<!-- Optimized Dashboard Template - admin-clustering-dashboard.component.html -->
<app-navbar></app-navbar>

<div class="clustering-dashboard">
  <div class="dashboard-header">
    <h1>🧠 Analiza Comportamentală Avansată</h1>
    <p>Recunoașterea pattern-urilor comportamentale cu optimizare automată pentru rezultate de calitate maximă</p>
  </div>

  <mat-tab-group class="main-tabs">
    <!-- Tab 1: Survey Selection & Overview -->
    <mat-tab label="📊 Analiză Optimizată">
      <div class="tab-content">
        <!-- Survey Selection Card -->
        <div class="survey-selection">
          <mat-card class="selection-card">
            <mat-card-header>
              <mat-card-title>Selectează Chestionarul pentru Analiză Optimizată</mat-card-title>
              <mat-card-subtitle>
                🚀 Noul sistem optimizează automat calitatea clustering-ului prin multiple iterații
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <!-- Loading State -->
              <div *ngIf="isLoadingSurveys" class="loading-container">
                <mat-spinner diameter="30"></mat-spinner>
                <p>Se încarcă chestionarele...</p>
              </div>
              
              <!-- Survey Selection Controls -->
              <div *ngIf="!isLoadingSurveys" class="selection-controls">
                <mat-select 
                  [(value)]="selectedSurveyId" 
                  placeholder="Selectează un chestionar..."
                  (selectionChange)="onSurveySelected($event.value)">
                  <mat-option *ngFor="let survey of availableSurveys" [value]="survey.id">
                    {{ survey.formTitle }} 
                    <span style="color: #666; margin-left: 8px;">
                      ({{ survey.responseCount || 0 }} răspunsuri)
                    </span>
                  </mat-option>
                </mat-select>
                
                <!-- ✅ MODIFIED: Single optimized analysis button -->
                <button 
                  mat-raised-button 
                  color="primary"
                  [disabled]="!selectedSurveyId || isAnalyzing"
                  (click)="startClusteringAnalysis()">
                  <span *ngIf="!isAnalyzing">🚀 Pornește Analiza Optimizată</span>
                  <span *ngIf="isAnalyzing">
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    Se optimizează...
                  </span>
                </button>
              </div>
              
              <!-- ✅ NEW: Optimization Progress Display -->
              <div *ngIf="optimizationProgress" class="optimization-progress">
                <div class="progress-header">
                  <h4>🔄 Optimizare în Curs</h4>
                  <span class="progress-time">{{ formatDuration(optimizationProgress.timeElapsed) }}</span>
                </div>
                
                <div class="progress-status">
                  <span>{{ getOptimizationStatusText() }}</span>
                  <span class="iteration-info">
                    (Iterația {{ optimizationProgress.currentIteration }} din {{ optimizationProgress.totalIterations }})
                  </span>
                </div>
                
                <mat-progress-bar 
                  mode="determinate" 
                  [value]="getOptimizationProgress()"
                  class="optimization-progress-bar">
                </mat-progress-bar>
                
                <div class="progress-stats" *ngIf="optimizationProgress.bestQualityScore > 0">
                  <span>Cel mai bun scor până acum: {{ (optimizationProgress.bestQualityScore * 100).toFixed(1) }}%</span>
                </div>
              </div>
              
              <!-- Error Message -->
              <div *ngIf="errorMessage" class="error-container">
                <mat-icon color="warn">error</mat-icon>
                <span>{{ errorMessage }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- ✅ NEW: Optimization Results Display -->
        <div *ngIf="optimizationResult && !isAnalyzing" class="optimization-results">
          <mat-card class="optimization-summary-card">
            <mat-card-header>
              <mat-card-title>
                🎯 Rezultatul Optimizării
                <span class="quality-badge" [ngClass]="getOptimizationQualityBadgeClass()">
                  {{ getOptimizationQualityBadge() }}
                </span>
              </mat-card-title>
              <mat-card-subtitle>{{ optimizationResult.optimizationSummary }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="optimization-metrics">
                <div class="metric">
                  <span class="metric-label">Calitate Inițială:</span>
                  <span class="metric-value">{{ (optimizationResult.initialQualityScore * 100).toFixed(1) }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Calitate Finală:</span>
                  <span class="metric-value final">{{ (optimizationResult.finalQualityScore * 100).toFixed(1) }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Îmbunătățire:</span>
                  <span class="metric-value improvement" 
                        [ngClass]="{'positive': optimizationResult.qualityImprovement > 0, 'neutral': optimizationResult.qualityImprovement <= 0}">
                    {{ optimizationResult.qualityImprovement > 0 ? '+' : '' }}{{ optimizationResult.qualityImprovement.toFixed(1) }}%
                  </span>
                </div>
                <div class="metric">
                  <span class="metric-label">Timp Total:</span>
                  <span class="metric-value">{{ formatDuration(optimizationResult.totalDuration) }}</span>
                </div>
              </div>
              
              <!-- Optimization Details Toggle -->
              <div class="optimization-details-toggle">
                <button 
                  mat-button 
                  (click)="showOptimizationDetails = !showOptimizationDetails">
                  {{ showOptimizationDetails ? '🔼 Ascunde' : '🔽 Vezi' }} Detaliile Optimizării
                </button>
              </div>
              
              <!-- Detailed Optimization Steps -->
              <div *ngIf="showOptimizationDetails" class="optimization-details">
                <h5>📋 Pașii Optimizării:</h5>
                <div class="iteration-list">
                  <div 
                    *ngFor="let iteration of optimizationResult.iterations; let i = index"
                    class="iteration-item"
                    [ngClass]="{'best-iteration': iteration.qualityScore === optimizationResult.finalQualityScore}">
                    <div class="iteration-header">
                      <span class="iteration-number">{{ iteration.iteration }}</span>
                      <span class="iteration-action">{{ getIterationActionLabel(iteration.action) }}</span>
                      <span class="iteration-quality">{{ (iteration.qualityScore * 100).toFixed(1) }}%</span>
                      <span class="iteration-duration">{{ formatDuration(iteration.duration) }}</span>
                    </div>
                    <div class="iteration-clusters">{{ iteration.clusterCount }} clustere</div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Analysis Results Section -->
        <div *ngIf="clusteringSummary" class="analysis-results">
          <!-- Overview Statistics -->
          <div class="overview-stats">
            <mat-card class="summary-card">
              <mat-card-header>
                <mat-card-title>📊 Rezultatele Analizei Optimizate</mat-card-title>
                <mat-card-subtitle>
                  Scorul de calitate: {{ (clusteringSummary.qualityScore * 100).toFixed(1) }}%
                  <span *ngIf="optimizationResult" class="optimization-indicator">
                    ✨ OPTIMIZAT
                  </span>
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-stats">
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalClusters }}</div>
                    <div class="stat-label">Grupuri Comportamentale</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalParticipants }}</div>
                    <div class="stat-label">Participanți Analizați</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ getUniqueOccupations() }}</div>
                    <div class="stat-label">Ocupații Diferite</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Insights Card -->
            <mat-card class="insights-card" *ngIf="clusteringSummary.insights && clusteringSummary.insights.length > 0">
              <mat-card-header>
                <mat-card-title>💡 Insight-uri Cheie</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <ul class="insights-list">
                  <li *ngFor="let insight of clusteringSummary.insights">{{ insight }}</li>
                </ul>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Detailed Clusters Section -->
          <div class="clusters-detailed">
            <h2>🎯 Profilurile Comportamentale Identificate</h2>
            
            <mat-accordion class="clusters-accordion">
              <mat-expansion-panel 
                *ngFor="let cluster of clusteringSummary.clusters; let i = index"
                class="cluster-panel"
                [ngClass]="'cluster-panel-' + i">
                
                <!-- Cluster Header -->
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <div class="cluster-header">
                      <div class="cluster-icon">{{ getClusterIcon(cluster.name) }}</div>
                      <div class="cluster-basic-info">
                        <h3>{{ cluster.name }}</h3>
                        <div class="cluster-stats">
                          <span class="participant-count">{{ cluster.size }} participanți</span>
                          <span class="percentage">({{ cluster.percentage.toFixed(1) }}%)</span>
                          <span class="performance-badge" [ngClass]="getPerformanceBadgeClass(cluster.performanceMetrics.technicalAptitude)">
                            {{ getPerformanceLabel(cluster.performanceMetrics.technicalAptitude) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ cluster.description }}
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Cluster Detailed Content -->
                <div class="cluster-detailed-content">
                  <!-- Performance Metrics -->
                  <div class="metrics-section">
                    <h4>📊 Metrici de Performanță</h4>
                    <div class="metrics-grid">
                      <div class="metric-item">
                        <div class="metric-label">Aptitudine Tehnică</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.technicalAptitude * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.technicalAptitude * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Viteză</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.speedIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.speedIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Precizie</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.precisionIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.precisionIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Încredere</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.confidenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.confidenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Sistematic</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.systematicIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.systematicIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Persistență</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.persistenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.persistenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Detailed Profile -->
                  <div class="profile-section">
                    <h4>👤 Profil Demografic și Comportamental Detaliat</h4>
                    <div class="profile-content" [innerHTML]="formatProfileForDisplay(cluster.detailedProfile)"></div>
                  </div>

                  <!-- Key Characteristics -->
                  <div class="characteristics-section" *ngIf="cluster.characteristics && cluster.characteristics.length > 0">
                    <h4>🏷️ Caracteristici Cheie</h4>
                    <div class="characteristics-tags">
                      <span 
                        *ngFor="let char of cluster.characteristics" 
                        class="characteristic-tag">
                        {{ char }}
                      </span>
                    </div>
                  </div>

                  <!-- Cluster Actions -->
                  <div class="cluster-actions">
                    <button 
                      mat-stroked-button 
                      color="primary"
                      (click)="viewClusterDetails(cluster.id)">
                      👁️ Vezi Participanții
                    </button>
                    <button 
                      mat-stroked-button 
                      color="accent"
                      (click)="exportClusterData(cluster.id)">
                      📊 Exportă Date
                    </button>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </div>

        <!-- Placeholder when no analysis has been run -->
        <div *ngIf="!clusteringSummary && !isAnalyzing && !optimizationProgress" class="placeholder-message">
          <mat-icon>analytics</mat-icon>
          <h3>Analiza Comportamentală Optimizată</h3>
          <p>
            Selectează un chestionar și pornește analiza optimizată pentru a descoperi 
            pattern-urile comportamentale cu cea mai bună calitate posibilă.
          </p>
          <p>
            <strong>Noul sistem optimizează automat:</strong><br>
            ✅ Recalculează metricile pentru consistență<br>
            ✅ Testează diferite numere de clustere<br>
            ✅ Returnează rezultatul cu calitatea maximă
          </p>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Fisher Test (existing) -->
    <mat-tab label="🔬 Analiză Fisher">
      <div class="tab-content">
        <app-fisher-test [surveyId]="selectedSurveyId"></app-fisher-test>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>