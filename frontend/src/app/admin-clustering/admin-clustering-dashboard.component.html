<app-navbar></app-navbar>

<div class="clustering-dashboard">
  <div class="dashboard-header">
    <h1>ğŸ§  Analiza ComportamentalÄƒ AvansatÄƒ</h1>
    <p>RecunoaÈ™terea pattern-urilor comportamentale È™i insight-uri demografice detaliate</p>
  </div>

  <!-- âœ… NEW: Category Consistency Section -->
  <div class="category-consistency-section">
    <mat-card class="consistency-card">
      <mat-card-header>
        <mat-card-title>ğŸ”§ ConsistenÈ›a Categoriilor</mat-card-title>
        <mat-card-subtitle>VerificÄƒ È™i standardizeazÄƒ categoriile pentru analizÄƒ precisÄƒ</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="consistency-actions">
          <button 
            mat-raised-button 
            color="primary"
            [disabled]="isCheckingConsistency"
            (click)="checkCategoryConsistency()">
            <span *ngIf="!isCheckingConsistency">ğŸ” VerificÄƒ ConsistenÈ›a</span>
            <span *ngIf="isCheckingConsistency">
              <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
              Se verificÄƒ...
            </span>
          </button>
          
          <button 
            mat-raised-button 
            color="warn"
            [disabled]="isFixingCategories"
            (click)="fixAllCategories()">
            <span *ngIf="!isFixingCategories">ğŸ”§ StandardizeazÄƒ Toate Categoriile</span>
            <span *ngIf="isFixingCategories">
              <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
              Se standardizeazÄƒ...
            </span>
          </button>
        </div>

        <!-- Category Consistency Results -->
        <div *ngIf="categoryConsistencyResults" class="consistency-results">
          <h4>ğŸ“Š Rezultatele VerificÄƒrii</h4>
          <div class="consistency-stats">
            <div class="stat-item">
              <strong>Total rÄƒspunsuri:</strong> {{ categoryConsistencyResults.data.totalResponses }}
            </div>
            <div class="stat-item">
              <strong>VariaÈ›ii demografice:</strong> {{ categoryConsistencyResults.summary.totalDemographicVariations }}
            </div>
            <div class="stat-item">
              <strong>VariaÈ›ii comportamentale:</strong> {{ categoryConsistencyResults.summary.totalBehavioralVariations }}
            </div>
            <div class="stat-item">
              <strong>Stare:</strong> 
              <span [ngStyle]="{
                color: getCategoryConsistencyStatus() === 'good' ? '#4caf50' : 
                       getCategoryConsistencyStatus() === 'fair' ? '#ff9800' : '#f44336'
              }">
                {{ getCategoryConsistencyStatus() === 'good' ? 'BunÄƒ' : 
                   getCategoryConsistencyStatus() === 'fair' ? 'AcceptabilÄƒ' : 'NecesitÄƒ Ã®mbunÄƒtÄƒÈ›ire' }}
              </span>
            </div>
          </div>

          <!-- Warning if categories need fixing -->
          <div *ngIf="shouldShowCategoryWarning()" class="category-details">
            <h5>âš ï¸ AtenÈ›ie: Categorii Inconsistente Detectate</h5>
            <p>S-au detectat prea multe variaÈ›ii Ã®n categoriile demografice È™i comportamentale. 
               Aceasta poate afecta calitatea analizei de clustering. Se recomandÄƒ folosirea butonului 
               "StandardizeazÄƒ Toate Categoriile" pentru a corecta aceste inconsistenÈ›e.</p>
          </div>

          <!-- Details about category variations -->
          <div class="category-details">
            <h5>ğŸ“‹ Detalii Demografice</h5>
            <div class="category-list">
              <div><strong>Grupe de vÃ¢rstÄƒ:</strong> {{ categoryConsistencyResults.data.demographicCategories.ageGroups.join(', ') }}</div>
              <div><strong>Genuri:</strong> {{ categoryConsistencyResults.data.demographicCategories.genders.join(', ') }}</div>
              <div><strong>Nivele educaÈ›ie:</strong> {{ categoryConsistencyResults.data.demographicCategories.educationLevels.join(', ') }}</div>
              <div><strong>OcupaÈ›ii:</strong> {{ categoryConsistencyResults.data.demographicCategories.occupations.join(', ') }}</div>
              <div><strong>Nivele STEM:</strong> {{ categoryConsistencyResults.data.demographicCategories.stemLevels.join(', ') }}</div>
            </div>

            <h5>ğŸ§  Detalii Comportamentale</h5>
            <div class="category-list">
              <div><strong>Stiluri rezolvare probleme:</strong> {{ categoryConsistencyResults.data.behavioralCategories.problemSolvingStyles.join(', ') }}</div>
              <div><strong>Nivele comfort tehnic:</strong> {{ categoryConsistencyResults.data.behavioralCategories.techComfortLevels.join(', ') }}</div>
              <div><strong>Stiluri gestionare erori:</strong> {{ categoryConsistencyResults.data.behavioralCategories.errorHandlingStyles.join(', ') }}</div>
              <div><strong>ExperienÈ›Äƒ asamblare:</strong> {{ categoryConsistencyResults.data.behavioralCategories.assemblyExperience.join(', ') }}</div>
              <div><strong>FrecvenÈ›Äƒ gaming:</strong> {{ categoryConsistencyResults.data.behavioralCategories.gamingFrequencies.join(', ') }}</div>
            </div>
          </div>
        </div>

        <!-- Fix Categories Results -->
        <div *ngIf="fixCategoriesResults" class="consistency-results">
          <h4>ğŸ”§ Rezultatele StandardizÄƒrii</h4>
          <div class="consistency-stats">
            <div class="stat-item">
              <strong>RÄƒspunsuri procesate:</strong> {{ fixCategoriesResults.data.processedCount }}
            </div>
            <div class="stat-item">
              <strong>Categorii corectate:</strong> {{ fixCategoriesResults.data.categoriesFixed }}
            </div>
            <div class="stat-item">
              <strong>Procentaj Ã®mbunÄƒtÄƒÈ›ire:</strong> {{ fixCategoriesResults.data.fixPercentage }}
            </div>
          </div>
          <p><strong>Recomandare:</strong> {{ fixCategoriesResults.recommendation }}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Fisher Test Component -->
  <app-fisher-test [surveyId]="selectedSurveyId"></app-fisher-test>

  <mat-tab-group class="main-tabs">
    <!-- Tab 1: Survey Selection & Overview -->
    <mat-tab label="ğŸ“Š Prezentare GeneralÄƒ">
      <div class="tab-content">
        <!-- Survey Selection Card -->
        <div class="survey-selection">
          <mat-card class="selection-card">
            <mat-card-header>
              <mat-card-title>SelecteazÄƒ Chestionarul pentru AnalizÄƒ</mat-card-title>
              <mat-card-subtitle>Alege un chestionar cu rÄƒspunsuri complete pentru a analiza pattern-urile comportamentale</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <!-- Loading State -->
              <div *ngIf="isLoadingSurveys" class="loading-container">
                <mat-spinner diameter="30"></mat-spinner>
                <p>Se Ã®ncarcÄƒ chestionarele...</p>
              </div>
              
              <!-- Survey Selection Controls -->
              <div *ngIf="!isLoadingSurveys" class="selection-controls">
                <mat-select 
                  [(value)]="selectedSurveyId" 
                  placeholder="SelecteazÄƒ un chestionar..."
                  (selectionChange)="onSurveySelected($event.value)">
                  <mat-option *ngFor="let survey of availableSurveys" [value]="survey.id">
                    {{ survey.formTitle }} 
                    <span style="color: #666; margin-left: 8px;">
                      ({{ survey.responseCount || 0 }} rÄƒspunsuri)
                    </span>
                  </mat-option>
                </mat-select>
                
                <!-- Analysis Button -->
                <button 
                  mat-raised-button 
                  color="primary"
                  [disabled]="!selectedSurveyId || isAnalyzing"
                  (click)="startClusteringAnalysis()">
                  <span *ngIf="!isAnalyzing">ğŸ”¬ PorneÈ™te Analiza</span>
                  <span *ngIf="isAnalyzing">
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    Se analizeazÄƒ...
                  </span>
                </button>
                
                <!-- Recompute Metrics Button -->
                <button 
                  mat-raised-button 
                  color="accent"
                  [disabled]="!selectedSurveyId || isRecomputing"
                  (click)="recomputeMetrics()">
                  <span *ngIf="!isRecomputing">âš™ï¸ RecalculeazÄƒ Metricile</span>
                  <span *ngIf="isRecomputing">
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    Se recalculeazÄƒ...
                  </span>
                </button>
              </div>
              
              <!-- Error Message -->
              <div *ngIf="errorMessage" class="error-container">
                <mat-icon color="warn">error</mat-icon>
                <span>{{ errorMessage }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Analysis Results Section -->
        <div *ngIf="clusteringSummary" class="analysis-results">
          <!-- Overview Statistics -->
          <div class="overview-stats">
            <mat-card class="summary-card">
              <mat-card-header>
                <mat-card-title>Rezultatele Analizei</mat-card-title>
                <mat-card-subtitle>Scorul de calitate: {{ (clusteringSummary.qualityScore * 100).toFixed(1) }}%</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-stats">
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalClusters }}</div>
                    <div class="stat-label">Grupuri Comportamentale</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ clusteringSummary.totalParticipants }}</div>
                    <div class="stat-label">ParticipanÈ›i AnalizaÈ›i</div>
                  </div>
                  <div class="stat">
                    <div class="stat-number">{{ getUniqueOccupations() }}</div>
                    <div class="stat-label">OcupaÈ›ii Diferite</div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Insights Card -->
            <mat-card class="insights-card" *ngIf="clusteringSummary.insights && clusteringSummary.insights.length > 0">
              <mat-card-header>
                <mat-card-title>ğŸ’¡ Insight-uri Cheie</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <ul class="insights-list">
                  <li *ngFor="let insight of clusteringSummary.insights">{{ insight }}</li>
                </ul>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Detailed Clusters Section -->
          <div class="clusters-detailed">
            <h2>ğŸ¯ Profilurile Comportamentale Identificate</h2>
            
            <mat-accordion class="clusters-accordion">
              <mat-expansion-panel 
                *ngFor="let cluster of clusteringSummary.clusters; let i = index"
                class="cluster-panel"
                [ngClass]="'cluster-panel-' + i">
                
                <!-- Cluster Header -->
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <div class="cluster-header">
                      <div class="cluster-icon">{{ getClusterIcon(cluster.name) }}</div>
                      <div class="cluster-basic-info">
                        <h3>{{ cluster.name }}</h3>
                        <div class="cluster-stats">
                          <span class="participant-count">{{ cluster.size }} participanÈ›i</span>
                          <span class="percentage">({{ cluster.percentage.toFixed(1) }}%)</span>
                          <span class="performance-badge" [ngClass]="getPerformanceBadgeClass(cluster.performanceMetrics.technicalAptitude)">
                            {{ getPerformanceLabel(cluster.performanceMetrics.technicalAptitude) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ cluster.description }}
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Cluster Detailed Content -->
                <div class="cluster-detailed-content">
                  <!-- Performance Metrics -->
                  <div class="metrics-section">
                    <h4>ğŸ“Š Metrici de PerformanÈ›Äƒ</h4>
                    <div class="metrics-grid">
                      <div class="metric-item">
                        <div class="metric-label">Aptitudine TehnicÄƒ</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.technicalAptitude * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.technicalAptitude * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index VitezÄƒ</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.speedIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.speedIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Precizie</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.precisionIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.precisionIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Ãncredere</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.confidenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.confidenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index Sistematic</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.systematicIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.systematicIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                      <div class="metric-item">
                        <div class="metric-label">Index PersistenÈ›Äƒ</div>
                        <div class="metric-bar">
                          <div class="metric-fill" [style.width.%]="cluster.performanceMetrics.persistenceIndex * 100"></div>
                          <span class="metric-value">{{ (cluster.performanceMetrics.persistenceIndex * 100).toFixed(1) }}%</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Detailed Profile -->
                  <div class="profile-section">
                    <h4>ğŸ‘¤ Profil Demografic È™i Comportamental Detaliat</h4>
                    <div class="profile-content" [innerHTML]="formatProfileForDisplay(cluster.detailedProfile)"></div>
                  </div>

                  <!-- Key Characteristics -->
                  <div class="characteristics-section" *ngIf="cluster.characteristics && cluster.characteristics.length > 0">
                    <h4>ğŸ·ï¸ Caracteristici Cheie</h4>
                    <div class="characteristics-tags">
                      <span 
                        *ngFor="let char of cluster.characteristics" 
                        class="characteristic-tag">
                        {{ char }}
                      </span>
                    </div>
                  </div>

                  <!-- Cluster Actions -->
                  <div class="cluster-actions">
                    <button 
                      mat-stroked-button 
                      color="primary"
                      (click)="viewClusterDetails(cluster.id)">
                      ğŸ‘ï¸ Vezi ParticipanÈ›ii
                    </button>
                    <button 
                      mat-stroked-button 
                      color="accent"
                      (click)="exportClusterData(cluster.id)">
                      ğŸ“Š ExportÄƒ Date
                    </button>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </div>

        <!-- Placeholder when no analysis is available -->
        <div *ngIf="!clusteringSummary && !isAnalyzing" class="placeholder-message">
          <mat-icon>analytics</mat-icon>
          <h3>PregÄƒtit pentru AnalizÄƒ</h3>
          <p>SelecteazÄƒ un chestionar È™i porneÈ™te analiza pentru a descoperi pattern-urile comportamentale ale participanÈ›ilor.</p>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Advanced Analytics -->
    <mat-tab label="ğŸ“ˆ AnalizÄƒ AvansatÄƒ">
      <div class="tab-content">
        <div class="placeholder-message">
          <mat-icon>assessment</mat-icon>
          <h3>AnalizÄƒ AvansatÄƒ</h3>
          <p>FuncÈ›ionalitate Ã®n dezvoltare - analize detaliate È™i comparaÈ›ii Ã®ntre chestionare.</p>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 3: Insights & Reports -->
    <mat-tab label="ğŸ“‹ Rapoarte & Insight-uri">
      <div class="tab-content">
        <div class="placeholder-message">
          <mat-icon>description</mat-icon>
          <h3>Rapoarte & Insight-uri</h3>
          <p>FuncÈ›ionalitate Ã®n dezvoltare - generare automatÄƒ de rapoarte È™i insight-uri acÈ›ionabile.</p>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>